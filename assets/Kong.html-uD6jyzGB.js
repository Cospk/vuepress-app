import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as n,o as t}from"./app-Da47ddN4.js";const l={};function e(h,s){return t(),a("div",null,s[0]||(s[0]=[n(`<p><br><br></p><h2 id="_01、概述" tabindex="-1"><a class="header-anchor" href="#_01、概述"><span>01、概述</span></a></h2><br><p><a href="https://cloud.tencent.com/product/apigw?from_column=20065&amp;from=20065" target="_blank" rel="noopener noreferrer">API 网关</a>（API Gateway）是一种服务器，充当应用程序编程接口（API）的入口点，执行多种任务以简化、安全和优化 API 通信。API 网关的主要功能包括：</p><ol><li><strong>请求</strong>路由：将传入的 API 请求路由到相应的后端服务，基于请求的路径、参数等进行分发。</li><li><strong>协议转换：</strong> 处理不同协议中的请求和响应，允许客户端和后端服务使用不同的通信协议。</li><li><strong>请求和响应转换：</strong> 修改传入请求或传出响应的结构，以匹配所需的格式或标准。</li><li><strong>安全性：</strong> 强制执行<a href="https://cloud.tencent.com/product/mfas?from_column=20065&amp;from=20065" target="_blank" rel="noopener noreferrer">身份验证</a>和授权机制，确保 API 通信的安全性。</li><li><strong>速率限制：</strong> 控制客户端在特定时间段内发出的请求数量，以防滥用。</li><li><strong>日志记录和监控：</strong> 记录 API 请求和响应，提供监控和分析功能，以跟踪 API 的使用情况和性能。</li><li><strong>缓存：</strong> 缓存后端服务的响应，提高性能并减轻后端服务器的负载。</li><li><strong>错误处理：</strong> 处理请求期间的错误，提供标准化的错误响应，并可能屏蔽后端错误以防止直接传递给客户端。</li><li><strong>服务发现： 在微服务架构中，协助客户端动态定位适当的后端服务。</strong></li><li><strong>API 文档：</strong> 生成并公开 API 的文档，以帮助开发人员理解和使用可用的端点。</li><li><strong>请求验证：</strong> 验证传入请求的结构和内容，确保其符合预期的格式和标准。</li></ol><p>总的来说，API 网关充当集中的、管理的入口，通过执行这些功能来增强整个 API 生态系统的管理和效率</p><p><br><br></p><h2 id="_02、网关选择" tabindex="-1"><a class="header-anchor" href="#_02、网关选择"><span>02、网关选择</span></a></h2><br><p>云原生领域APISIX更加优于Kong和Nginx，Apisix 是对标云原生网关的，严格来说和 Spring Cloud Gateway 这种业务形网关没什么可比性。</p><p>如果是小公司，架构简单，业务单一，则使用Gateway作为业务网关完全够用，而且还便于定制化扩展。若架构复杂，业务流量大，k8s容器化部署，对标云原生的则可以使用Apisix。也可以Apisix和gateway搭配使用，流量网关使用Apisix，业务网关使用gateway，使用流量网关对公网入口流量进行转发到业务网关，再由业务网关将请求转发至各个系统</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/getewayForFlow_service.png" alt="image-20240703161531109" tabindex="0" loading="lazy"><figcaption>image-20240703161531109</figcaption></figure><br><p>常见的网关横向对比</p><table><thead><tr><th style="text-align:center;">API网关</th><th>Kong</th><th>APISIX</th><th>Trk</th><th>APIgee</th></tr></thead><tbody><tr><td style="text-align:center;">部署方式</td><td>单机和集群</td><td>单机和集群</td><td>单机和集群</td><td>不支持单机</td></tr><tr><td style="text-align:center;">数据存储</td><td>Postgres和Cassandra</td><td>etcd</td><td>Redis</td><td>Postgres、Cassandra和zookeeper</td></tr><tr><td style="text-align:center;">是否开源</td><td>apache2.0协议</td><td>apache2.0协议</td><td>MPL协议</td><td>否</td></tr><tr><td style="text-align:center;">核心技术</td><td>Nginx+Lua</td><td>Nginx+Lua</td><td>Golang</td><td>未知</td></tr><tr><td style="text-align:center;">支持私有化部署</td><td>是</td><td>是</td><td>是</td><td>否</td></tr><tr><td style="text-align:center;">自定义插件</td><td>是</td><td>是</td><td>是</td><td>否</td></tr><tr><td style="text-align:center;">社区活跃度</td><td>高</td><td>高</td><td>高</td><td>中</td></tr><tr><td style="text-align:center;">支持yaml</td><td>是</td><td>是</td><td>否</td><td>否</td></tr></tbody></table><br><p>选型依据:</p><ul><li>部署和运维成本：单机是否可以完成部署？还是需要多个节点配合？是否依赖外部的数据库？是否有web控制台可操控整个集群</li><li>开源还是闭源：开源许可证是否友好？可否自己写插件扩展网关功能？使用后迁移其他网关成本怎么样？是否会锁定特定平台</li><li>能否私有化部署：是否支持部署在用户自己的服务器？是否支持多云、混合云的部署模式？</li><li>功能：是否支持动态上游、动态SSL证书、主被动健康检查等基本功能？是否对接常用的统计或监控组件？能否通过Restful API或yaml配置文件方式控制网关配置？</li><li>社区：能否通过github、stack Overflow等联系方式联系开发者？背后是否有商业公司支持</li><li>商业支持和价格：开源版本和商业版本价格是否差异很大？商业版本按照API调用次数还是订阅方式收费？</li></ul><p><br><br></p><h2 id="_03、kong的安装" tabindex="-1"><a class="header-anchor" href="#_03、kong的安装"><span>03、Kong的安装</span></a></h2><br><p>Kong是一个<code>开源</code>的API网关，它是一个针对API的一个管理工具。你可以在那些上游服务之前额外地实现一些功能。</p><p>Kong是基于NGINX和Apache Cassandra或PostgreSQL构建的，能提供易于使用的<code>RESTfuI API</code>来操作和配置API管理系统，所以它可以水平扩展多个Kong服务器，通过前置的负载均衡配置把请求均匀地分发到各个Server，来应对大批量的网络请求。</p><p>8001:kong的管理的端口 : http:8001//+请求+参数</p><p>8000:用户访问：统一路由端口</p><p>1337: konga 地址</p><ul><li><p>参考文档：<a href="https://github.com/qianyugang/kong-docs-cn" target="_blank" rel="noopener noreferrer">https://github.com/qianyugang/kong-docs-cn</a></p></li><li><p>github文档：<a href="https://github.com/Kong/kong" target="_blank" rel="noopener noreferrer">https://github.com/Kong/kong</a></p></li></ul><br><h3 id="使用docker安装" tabindex="-1"><a class="header-anchor" href="#使用docker安装"><span>☁️使用Docker安装</span></a></h3><h4 id="_1、启动数据库" tabindex="-1"><a class="header-anchor" href="#_1、启动数据库"><span>1、启动数据库</span></a></h4><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kong-database</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">           -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 5432:5432</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">           -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;POSTGRES_USER=kong&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">           -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;POSTGRES_DB=kong&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">           -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;POSTGRES_PASSWORD=kong&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">           postgres:12</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果是云服务器记得开放：5432 端口。然后在本地连接即可。</p><h4 id="_2、初始化数据" tabindex="-1"><a class="header-anchor" href="#_2、初始化数据"><span>2、初始化数据</span></a></h4><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --rm</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_LOG_LEVEL=debug&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_DATABASE=postgres&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_PG_HOST=121.199.66.66&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_PG_USER=kong&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_PG_PASSWORD=kong&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_CASSANDRA_CONTACT_POINTS=kong-database&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    kong:latest</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kong</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> migrations</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bootstrap</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-安装方式一-docker安装kong" tabindex="-1"><a class="header-anchor" href="#_3-安装方式一-docker安装kong"><span>3：安装方式一：Docker安装Kong</span></a></h4><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kong</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_DATABASE=postgres&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_PG_HOST=121.199.66.66&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_PG_PASSWORD=kong&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_CASSANDRA_CONTACT_POINTS=kong-database&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_PROXY_ACCESS_LOG=/dev/stdout&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_ADMIN_ACCESS_LOG=/dev/stdout&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_PROXY_ERROR_LOG=/dev/stderr&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_ADMIN_ERROR_LOG=/dev/stderr&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 8000:8000</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 8443:8443</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 8001:8001</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 8444:8444</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kong:latest</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4、安装方式二-手动安装kong" tabindex="-1"><a class="header-anchor" href="#_4、安装方式二-手动安装kong"><span>4、安装方式二：手动安装Kong</span></a></h4><p>可以到这里找下载链接： <a href="https://docs.konghq.com/install/centos/" target="_blank" rel="noopener noreferrer">https://docs.konghq.com/install/centos/</a></p><p>可以到这里找下载链接： <a href="https://docs.konghq.com/install/centos/" target="_blank" rel="noopener noreferrer">https://docs.konghq.com/install/centos/</a></p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -1sLf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;https://packages.konghq.com/public/gateway-37/config.rpm.txt?distro=el&amp;codename=$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rpm</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --eval</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;%{rhel}&#39;)&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tee</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/yum.repos.d/kong-gateway-37.repo</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yum</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -q</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> makecache</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -y</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --disablerepo=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;*&#39;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --enablerepo=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;kong-gateway-37&#39;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yum</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -y</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kong-3.7.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编辑Kong配置</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/kong/kong.conf.default</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/kong/kong.conf</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">vim</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/kong/kong.conf</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#修改如下内容</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">database</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postgres</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pg_host</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.1.102</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # 这⾥得配置对外ip地址 不能是127.0.0.1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pg_port</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5432</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # Port of the Postgres server.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pg_timeout</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5000</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # Defines the timeout (in ms), for connecting,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # reading and writing.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pg_user</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kong</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # Postgres user.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pg_password</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kong</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # Postgres user&#39;s password.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pg_database</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kong</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # The database name to connect to.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dns_resolver</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 127.0.0.1:8600</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #这个配置很重要，配置的是consul的dns端⼝，默认是8600 可以⾃</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">admin_listen</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0.0.0.0:8001</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reuseport</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> backlog=16384,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 127.0.0.1:8444</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reuseport</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> backlog=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">16384</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">proxy_listen</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0.0.0.0:8000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reuseport</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> backlog=16384,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 0.0.0.0:8443</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reuseport</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> backlog=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">16384</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>初始化kong的数据库</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">kong</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> migrations</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bootstrap</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/kong/kong.conf</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #这⾥是初始化⽣成数据库</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">kong</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> start</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/kong/kong.conf</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#添加防⽕墙规则</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">firewall-cmd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --zone=public</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --add-port=8001/tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --permanent</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">firewall-cmd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --zone=public</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --add-port=8000/tcp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --permanent</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如果是云服务器</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">直接在安全组中，开放8000、8001即可。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果出错 <code>Error: /usr/local/share/lua/5.1/kong/cmd/utils/migrations.lua:20: New migrations available; run &#39;kong migrations up&#39; to proceed</code> 执行如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>kong migrations up --v</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>然后在启动：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@iZf8z8fcvqy10f6a60f8ayZ ~]# kong start -c /etc/kong/kong.conf</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Database</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> has</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pending</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> migrations:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                 core:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 016_280_to_300</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                 acme:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 003_350_to_360</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">             ai-proxy:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 001_360_to_370</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">             http-log:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 001_280_to_300</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        opentelemetry:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 001_331_to_332</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        post-function:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 001_280_to_300</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">         pre-function:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 001_280_to_300</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        rate-limiting:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 006_350_to_360</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">response-ratelimiting:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 001_350_to_360</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Kong</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> started</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明kong安装成功了。</p><p>访问查看kong的节点信息：<a href="http://121.199.66.66:8001/" target="_blank" rel="noopener noreferrer">http://121.199.66.66:8001/</a></p><h4 id="_5、-安装konga" tabindex="-1"><a class="header-anchor" href="#_5、-安装konga"><span>5、 安装konga</span></a></h4><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1337:1337</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> konga</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pantsel/konga</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>安装成功以后访问如下：<a href="http://121.199.66.66:1337/" target="_blank" rel="noopener noreferrer">http://121.199.66.66:1337/</a></p><ol><li><p>注册账号</p></li><li><p>登录账号</p></li><li><p>配置kongadmin的链接</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_dockerInstall1.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>创建链接如下：</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_dockerInstall2.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>配置信息如下：</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_dockerInstall3.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure></li></ol><p><br><br></p><h2 id="_04、开始配置kong服务和路由" tabindex="-1"><a class="header-anchor" href="#_04、开始配置kong服务和路由"><span>04、开始配置Kong服务和路由</span></a></h2><br><h3 id="_1-准备工作" tabindex="-1"><a class="header-anchor" href="#_1-准备工作"><span>1.准备工作</span></a></h3><ul><li><p>部署Nacos</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>ls -lrt /etc/alternatives/java</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>安装MySQL</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>docker run -di --name=tensquare_mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=mkxiaoer centos/mysql-57-centos7</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>安装Redis</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">docker</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> myredis</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redis</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redis-server</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --requirepass</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mkxiaoer</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>把goods-api/goods-srv都部署道服务器上即可</p></li><li><p>开启链路追踪服务jaeger</p></li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span> </span></span>
<span class="line"><span>curl -i -X POST  http://localhost:8001/services/goods_list/routes \\</span></span>
<span class="line"><span>  --data &#39;hosts[]=121.199.66.66&#39; \\</span></span>
<span class="line"><span>  --data &#39;name=商品明&#39; \\</span></span>
<span class="line"><span>  --data &#39;strip_path=false&#39; \\</span></span>
<span class="line"><span>  --data &#39;paths[]=/&#39;\\</span></span>
<span class="line"><span>  --data &#39;methods[]=GET&amp;methods[]=POST&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-测试" tabindex="-1"><a class="header-anchor" href="#_2-测试"><span>2.测试</span></a></h3><p><a href="http://121.199.66.66:9200/api/v1/goods/detail/1" target="_blank" rel="noopener noreferrer">http://121.199.66.66:9200/api/v1/goods/detail/1</a></p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;code&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;data&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;createTime&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;2024-05-07 13:07:28 +0800 CST&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;updateTime&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;2024-05-07 13:07:28 +0800 CST&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;商品名称商品名称商品名称商品名称商品名称&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;sn&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;商品名称商品名称商品名称商品名称商品名称&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;categoryId&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;onSale&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#0184BC;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;isFree&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#0184BC;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;desc&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;商品名称商品名称商品名称商品名称商品名称&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;viewCount&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;isComment&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#0184BC;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;salePrice&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;price&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;img&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/static/img/goods/p1.jpg&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;images&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/static/img/goods/p1.jpg&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;contentImgs&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/static/img/goods/p1.jpg&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">},</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">&quot;msg&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;success&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明接口通畅，nacos服务正常，jeager出现链路日志，说明一切正常。</p><h3 id="_3-配置kong网关代理" tabindex="-1"><a class="header-anchor" href="#_3-配置kong网关代理"><span>3.配置Kong网关代理</span></a></h3><h4 id="a-配置服务services" tabindex="-1"><a class="header-anchor" href="#a-配置服务services"><span>a.配置服务Services</span></a></h4><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setServices.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>url 如果输入是：<a href="http://ip:9200/%E9%82%A3%E4%B9%88%E4%B8%8B%E9%9D%A2%E7%9A%84protocol/host/port%E5%B0%B1%E4%B8%8D%E7%94%A8%E8%BE%93%E5%85%A5%E4%BA%86%E3%80%82%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4url=protocol+host+port" target="_blank" rel="noopener noreferrer">http://ip:9200/那么下面的protocol/host/port就不用输入了。也就是说url=protocol+host+port</a></p><h4 id="b-添加路由" tabindex="-1"><a class="header-anchor" href="#b-添加路由"><span>b.添加路由</span></a></h4><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setRout1.png" alt="image_6" tabindex="0" loading="lazy"><figcaption>image_6</figcaption></figure><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setRout2.png" alt="image-20240704001646729" tabindex="0" loading="lazy"><figcaption>image-20240704001646729</figcaption></figure><p><strong>记得path的位置输入完毕/以后，要敲回车。</strong></p><h4 id="c-访问测试" tabindex="-1"><a class="header-anchor" href="#c-访问测试"><span>c.访问测试</span></a></h4><p>原来访问的地址是：</p><ul><li><a href="http://121.199.66.66:9200/api/v1/goods/detail/1" target="_blank" rel="noopener noreferrer">http://121.199.66.66:9200/api/v1/goods/detail/1</a></li></ul><p>被kong代理以后的地址是：</p><ul><li><a href="http://121.199.66.66:8000/api/v1/goods/detail/1" target="_blank" rel="noopener noreferrer">http://121.199.66.66:8000/api/v1/goods/detail/1</a></li></ul><p>其它的都是如此。</p><p>从这里可以得出结论：上面配置的path=/ 其实就是：<a href="http://121.199.66.66:8000" target="_blank" rel="noopener noreferrer">http://121.199.66.66:8000</a> == <a href="http://121.199.66.66:9200" target="_blank" rel="noopener noreferrer">http://121.199.66.66:9200</a></p><h4 id="d-配置商品服务的路径" tabindex="-1"><a class="header-anchor" href="#d-配置商品服务的路径"><span>d.配置商品服务的路径</span></a></h4><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setPath.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>从这里可以得出结论：上面配置的path=/api 其实就是：</p><p>公式：<a href="http://121.199.66.66:8000/api==" target="_blank" rel="noopener noreferrer">http://121.199.66.66:8000/api==</a> <a href="http://121.199.66.66:9200" target="_blank" rel="noopener noreferrer">http://121.199.66.66:9200</a></p><p>原来访问的地址是：</p><ul><li><a href="http://121.199.66.66:9200/api/v1/goods/detail/1" target="_blank" rel="noopener noreferrer">http://121.199.66.66:9200/api/v1/goods/detail/1</a></li></ul><p>被kong代理以后的地址是：</p><ul><li><a href="http://121.199.66.66:8000/api/api/v1/goods/detail/1" target="_blank" rel="noopener noreferrer">http://121.199.66.66:8000/api/api/v1/goods/detail/1</a></li></ul><p>解读：</p><p><a href="http://121.199.66.66:8000/api" target="_blank" rel="noopener noreferrer">http://121.199.66.66:8000/api</a> (kong代理的路由地址) + /api/v1/goods/detail/1(商品服务的地址)</p><p>如果想去掉一级/api，自然就是修改程序的router.go的地址，把/api这级别去掉就行，用kong的/api地址即可。否则会就重复出现。让开发者产生怪异的理解。如下：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> initialize</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	&quot;github.com/gin-gonic/gin&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	middlewares</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;kuangstudy-mall/apis/goods-web/middleawares&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	&quot;kuangstudy-mall/apis/goods-web/router&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	&quot;net/http&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> InitWebRouter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Engine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 开始整合ginweb框架</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	Router</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Default</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	Router</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GET</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/ping&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">context</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Context</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		context</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">JSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">StatusOK</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;pong&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 配置跨域，身份鉴权</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	Router</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Use</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">middlewares</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Cors</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">())</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 进行路由组的定义</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// routerGroup := Router.Group(&quot;/api/v1&quot;) 修改前</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	routerGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> Router</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Group</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/v1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//修改后</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 用户路由接口初始化</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	router</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">InitGoodsRouter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">routerGroup</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> Router</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><br><br></p><h2 id="_05、kong整合jwt" tabindex="-1"><a class="header-anchor" href="#_05、kong整合jwt"><span>05、Kong整合JWT</span></a></h2><br><h3 id="_1-新建一个consumer" tabindex="-1"><a class="header-anchor" href="#_1-新建一个consumer"><span>1：新建一个consumer</span></a></h3><h3 id="_2-给consumer添加一个认证jwt" tabindex="-1"><a class="header-anchor" href="#_2-给consumer添加一个认证jwt"><span>2：给consumer添加一个认证jwt</span></a></h3><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addJWT.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">customClaims</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> jtoken</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CustomClaims</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    ID</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:          </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">userInfoResponse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    NickName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:    </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">userInfoResponse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">NickName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    AuthorityId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">userInfoResponse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Role</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    StandardClaims</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">jwt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">StandardClaims</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        NotBefore</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unix</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        ExpiresAt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unix</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">60</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">24</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">300</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        Issuer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:    </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cc&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 上面的key和这里一致</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    },</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>screat必须和配置文件一致：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">jwt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">0*%fMk^#4zT2iNc4Xg81</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-配置全局的jwt" tabindex="-1"><a class="header-anchor" href="#_3-配置全局的jwt"><span>3：配置全局的jwt</span></a></h3><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setGlobalJWT.png" alt="image-20240704023637382" tabindex="0" loading="lazy"><figcaption>image-20240704023637382</figcaption></figure><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setPluginsJWT.png" alt="image-20240704023655097" tabindex="0" loading="lazy"><figcaption>image-20240704023655097</figcaption></figure><p>添加头部信息:</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addJWTInfo.png" alt="image-20240704025833132" tabindex="0" loading="lazy"><figcaption>image-20240704025833132</figcaption></figure><p>这里名字必须和代码中的一致。</p><h3 id="_4-修改代码" tabindex="-1"><a class="header-anchor" href="#_4-修改代码"><span>4：修改代码</span></a></h3><p>因为kong的token会携带一个前缀：Bearer所以代码中必须截断这个前缀才可以去验证。</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" data-title="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">package</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> middlewares</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	&quot;github.com/gin-gonic/gin&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	&quot;kuangstudy-mall/apis/goods-web/jtoken&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	&quot;net/http&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	&quot;strings&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/*</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">*</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">jwt的拦截器验证</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">*/</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> JWTAuth</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">HandlerFunc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Context</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		// 我们这里jwt鉴权取头部信息 x-token 登录时回返回token信息 这里前端需要把token存储到cookie或者本地localSstorage中 不过需要跟后端协商过期时间 可以约定刷新令牌或者重新登录</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		token</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Request</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;x-token&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> token</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">JSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">StatusUnauthorized</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">any</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">				&quot;code&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">601</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">				&quot;data&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">				&quot;msg&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;请登录&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			})</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// 挂起</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Abort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		token</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> strings</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Split</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">token</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot; &quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		j</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> jtoken</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NewJWT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		// parseToken 解析token包含的信息</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		claims</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> j</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ParseToken</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">token</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> err</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> err</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> jtoken</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">TokenExpired</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> err</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> jtoken</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">TokenExpired</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">					// 可以考虑续期或者刷新token</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">					c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">JSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">StatusUnauthorized</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">any</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">						&quot;code&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">601</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">						&quot;data&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">						&quot;msg&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:  </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;授权已过期&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">					})</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">					c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Abort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">					return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">JSON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">http</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">StatusUnauthorized</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;未登陆&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Abort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;claims&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">claims</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;userId&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">claims</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ID</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;userName&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">claims</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">NickName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;role&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">claims</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">AuthorityId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-开始测试" tabindex="-1"><a class="header-anchor" href="#_5-开始测试"><span>5：开始测试</span></a></h3><p>在登录的时候生成token，然后添加成为全局的即可</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_testApifoxSetToken.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>如果没有增加前缀：Bearer</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_testApifoxAddBearer.png" alt="image-20240704030334842" tabindex="0" loading="lazy"><figcaption>image-20240704030334842</figcaption></figure><p>增加了</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_testApifoxSetInfos.png" alt="image-20240704030351447" tabindex="0" loading="lazy"><figcaption>image-20240704030351447</figcaption></figure><p>说明配置成功了</p><p><strong>这里要注意几个点</strong></p><p>1：创建consumer时候的key必须和issuser一致</p><p>2：screatkey必须和程序代码的保持一致</p><p>3：添加全局的jwt的时候头部的token必须是：x-token</p><p>4：程序代码必须截断 Bearer</p><p>5：开始测试</p><p><br><br></p><h2 id="_06、kong限制限流器访问" tabindex="-1"><a class="header-anchor" href="#_06、kong限制限流器访问"><span>06、Kong限制限流器访问</span></a></h2><br><h3 id="_1-添加插件" tabindex="-1"><a class="header-anchor" href="#_1-添加插件"><span>1：添加插件</span></a></h3><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addPlugins.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><h3 id="_2-配置bot-detection" tabindex="-1"><a class="header-anchor" href="#_2-配置bot-detection"><span>2：配置Bot Detection</span></a></h3><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addPluginsSetBot.png" alt="image-20240704031951936" tabindex="0" loading="lazy"><figcaption>image-20240704031951936</figcaption></figure><p>3：开始测试</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_testBot.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>如果你要指派给conumer就填写，如果不填写就是全局的，前面的jwt也一样，不写consumer就是全局，写了就是针对某个consumer进行生效。</p><p><br><br></p><h2 id="_07、kong请求大小参数限制" tabindex="-1"><a class="header-anchor" href="#_07、kong请求大小参数限制"><span>07、Kong请求大小参数限制</span></a></h2><br><h3 id="_1-添加插件-1" tabindex="-1"><a class="header-anchor" href="#_1-添加插件-1"><span>1: 添加插件</span></a></h3><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addLimiting.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addLimitingSet.png" alt="image-20240704032839921" tabindex="0" loading="lazy"><figcaption>image-20240704032839921</figcaption></figure><h3 id="_2-开始测试" tabindex="-1"><a class="header-anchor" href="#_2-开始测试"><span>2：开始测试</span></a></h3><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_pluginsShow.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>测试</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addLimitingTest.png" alt="image-20240704032851910" tabindex="0" loading="lazy"><figcaption>image-20240704032851910</figcaption></figure><br><br><h2 id="_08、利用konga进行限流" tabindex="-1"><a class="header-anchor" href="#_08、利用konga进行限流"><span>08、利用kongA进行限流</span></a></h2><br><h3 id="_1-添加限流插件" tabindex="-1"><a class="header-anchor" href="#_1-添加限流插件"><span>1：添加限流插件</span></a></h3><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_pluginsShow.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addKongA.png" alt="image-20240704033828317" tabindex="0" loading="lazy"><figcaption>image-20240704033828317</figcaption></figure><h3 id="_2-基于ip地址的每分钟2次请求" tabindex="-1"><a class="header-anchor" href="#_2-基于ip地址的每分钟2次请求"><span>2：基于ip地址的每分钟2次请求</span></a></h3><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addKongASet1.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><h3 id="_3-开始测试" tabindex="-1"><a class="header-anchor" href="#_3-开始测试"><span>3：开始测试</span></a></h3><p>连续访问3次，前面2次正常，后面就出现限流的状态429和错误提示信息</p><figure><img src="https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_kongATest.png" alt="image-20240704033850225" tabindex="0" loading="lazy"><figcaption>image-20240704033850225</figcaption></figure>`,155)]))}const r=i(l,[["render",e],["__file","Kong.html.vue"]]),d=JSON.parse('{"path":"/middleware/%E7%BD%91%E5%85%B3/Kong.html","title":"Kong","lang":"zh-CN","frontmatter":{"title":"Kong","order":2,"author":"xiaoxie","date":"2025-01-01T00:00:00.000Z","tag":["web"],"star":true,"description":"01、概述 API 网关（API Gateway）是一种服务器，充当应用程序编程接口（API）的入口点，执行多种任务以简化、安全和优化 API 通信。API 网关的主要功能包括： 请求路由：将传入的 API 请求路由到相应的后端服务，基于请求的路径、参数等进行分发。 协议转换： 处理不同协议中的请求和响应，允许客户端和后端服务使用不同的通信协议。 请求...","head":[["meta",{"property":"og:url","content":"https://Cospk.github.io/vuepress-app/middleware/%E7%BD%91%E5%85%B3/Kong.html"}],["meta",{"property":"og:site_name","content":"Golang全栈指南"}],["meta",{"property":"og:title","content":"Kong"}],["meta",{"property":"og:description","content":"01、概述 API 网关（API Gateway）是一种服务器，充当应用程序编程接口（API）的入口点，执行多种任务以简化、安全和优化 API 通信。API 网关的主要功能包括： 请求路由：将传入的 API 请求路由到相应的后端服务，基于请求的路径、参数等进行分发。 协议转换： 处理不同协议中的请求和响应，允许客户端和后端服务使用不同的通信协议。 请求..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/getewayForFlow_service.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-01-17T08:43:17.000Z"}],["meta",{"property":"article:author","content":"xiaoxie"}],["meta",{"property":"article:tag","content":"web"}],["meta",{"property":"article:published_time","content":"2025-01-01T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-01-17T08:43:17.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Kong\\",\\"image\\":[\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/getewayForFlow_service.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_dockerInstall1.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_dockerInstall2.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_dockerInstall3.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setServices.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setRout1.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setRout2.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setPath.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addJWT.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setGlobalJWT.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_setPluginsJWT.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addJWTInfo.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_testApifoxSetToken.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_testApifoxAddBearer.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_testApifoxSetInfos.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addPlugins.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addPluginsSetBot.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_testBot.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addLimiting.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addLimitingSet.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_pluginsShow.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addLimitingTest.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_pluginsShow.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addKongA.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_addKongASet1.png\\",\\"https://gavvy-cloud.oss-cn-shenzhen.aliyuncs.com/web/kong_kongATest.png\\"],\\"datePublished\\":\\"2025-01-01T00:00:00.000Z\\",\\"dateModified\\":\\"2025-01-17T08:43:17.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"xiaoxie\\"}]}"]]},"headers":[{"level":2,"title":"01、概述","slug":"_01、概述","link":"#_01、概述","children":[]},{"level":2,"title":"02、网关选择","slug":"_02、网关选择","link":"#_02、网关选择","children":[]},{"level":2,"title":"03、Kong的安装","slug":"_03、kong的安装","link":"#_03、kong的安装","children":[{"level":3,"title":"☁️使用Docker安装","slug":"使用docker安装","link":"#使用docker安装","children":[]}]},{"level":2,"title":"04、开始配置Kong服务和路由","slug":"_04、开始配置kong服务和路由","link":"#_04、开始配置kong服务和路由","children":[{"level":3,"title":"1.准备工作","slug":"_1-准备工作","link":"#_1-准备工作","children":[]},{"level":3,"title":"2.测试","slug":"_2-测试","link":"#_2-测试","children":[]},{"level":3,"title":"3.配置Kong网关代理","slug":"_3-配置kong网关代理","link":"#_3-配置kong网关代理","children":[]}]},{"level":2,"title":"05、Kong整合JWT","slug":"_05、kong整合jwt","link":"#_05、kong整合jwt","children":[{"level":3,"title":"1：新建一个consumer","slug":"_1-新建一个consumer","link":"#_1-新建一个consumer","children":[]},{"level":3,"title":"2：给consumer添加一个认证jwt","slug":"_2-给consumer添加一个认证jwt","link":"#_2-给consumer添加一个认证jwt","children":[]},{"level":3,"title":"3：配置全局的jwt","slug":"_3-配置全局的jwt","link":"#_3-配置全局的jwt","children":[]},{"level":3,"title":"4：修改代码","slug":"_4-修改代码","link":"#_4-修改代码","children":[]},{"level":3,"title":"5：开始测试","slug":"_5-开始测试","link":"#_5-开始测试","children":[]}]},{"level":2,"title":"06、Kong限制限流器访问","slug":"_06、kong限制限流器访问","link":"#_06、kong限制限流器访问","children":[{"level":3,"title":"1：添加插件","slug":"_1-添加插件","link":"#_1-添加插件","children":[]},{"level":3,"title":"2：配置Bot Detection","slug":"_2-配置bot-detection","link":"#_2-配置bot-detection","children":[]}]},{"level":2,"title":"07、Kong请求大小参数限制","slug":"_07、kong请求大小参数限制","link":"#_07、kong请求大小参数限制","children":[{"level":3,"title":"1: 添加插件","slug":"_1-添加插件-1","link":"#_1-添加插件-1","children":[]},{"level":3,"title":"2：开始测试","slug":"_2-开始测试","link":"#_2-开始测试","children":[]}]},{"level":2,"title":"08、利用kongA进行限流","slug":"_08、利用konga进行限流","link":"#_08、利用konga进行限流","children":[{"level":3,"title":"1：添加限流插件","slug":"_1-添加限流插件","link":"#_1-添加限流插件","children":[]},{"level":3,"title":"2：基于ip地址的每分钟2次请求","slug":"_2-基于ip地址的每分钟2次请求","link":"#_2-基于ip地址的每分钟2次请求","children":[]},{"level":3,"title":"3：开始测试","slug":"_3-开始测试","link":"#_3-开始测试","children":[]}]}],"git":{"createdTime":1735628969000,"updatedTime":1737103397000,"contributors":[{"name":"xiaoxie001","username":"xiaoxie001","email":"xie18115@outlook.com","commits":2,"url":"https://github.com/xiaoxie001"}]},"readingTime":{"minutes":10.7,"words":3211},"filePathRelative":"middleware/网关/Kong.md","localizedDate":"2025年1月1日","autoDesc":true,"excerpt":"<p><br><br></p>\\n<h2>01、概述</h2>\\n<br>\\n<p><a href=\\"https://cloud.tencent.com/product/apigw?from_column=20065&amp;from=20065\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">API 网关</a>（API Gateway）是一种服务器，充当应用程序编程接口（API）的入口点，执行多种任务以简化、安全和优化 API 通信。API 网关的主要功能包括：</p>\\n<ol>\\n<li><strong>请求</strong>路由：将传入的 API 请求路由到相应的后端服务，基于请求的路径、参数等进行分发。</li>\\n<li><strong>协议转换：</strong> 处理不同协议中的请求和响应，允许客户端和后端服务使用不同的通信协议。</li>\\n<li><strong>请求和响应转换：</strong> 修改传入请求或传出响应的结构，以匹配所需的格式或标准。</li>\\n<li><strong>安全性：</strong> 强制执行<a href=\\"https://cloud.tencent.com/product/mfas?from_column=20065&amp;from=20065\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">身份验证</a>和授权机制，确保 API 通信的安全性。</li>\\n<li><strong>速率限制：</strong> 控制客户端在特定时间段内发出的请求数量，以防滥用。</li>\\n<li><strong>日志记录和监控：</strong> 记录 API 请求和响应，提供监控和分析功能，以跟踪 API 的使用情况和性能。</li>\\n<li><strong>缓存：</strong> 缓存后端服务的响应，提高性能并减轻后端服务器的负载。</li>\\n<li><strong>错误处理：</strong> 处理请求期间的错误，提供标准化的错误响应，并可能屏蔽后端错误以防止直接传递给客户端。</li>\\n<li><strong>服务发现： 在微服务架构中，协助客户端动态定位适当的后端服务。</strong></li>\\n<li><strong>API 文档：</strong> 生成并公开 API 的文档，以帮助开发人员理解和使用可用的端点。</li>\\n<li><strong>请求验证：</strong> 验证传入请求的结构和内容，确保其符合预期的格式和标准。</li>\\n</ol>"}');export{r as comp,d as data};
